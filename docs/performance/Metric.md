---
title: 性能指标
author: T8840
date: '2023-01-15'
---


## 性能指标
- QPS：每秒钟处理的查询量
- TPS：
- 并发量
    - 大量的并发风险：数据库连接数被沾满(max_connections默认为100）
- CPU使用率
    - 超高的CPU使用率风险：因CPU资源耗尽而出现宕机
- 磁盘IO
    - 风险：磁盘IO性能突然下降；其他大量消耗磁盘性能的计划任务
    - 解决风险措施：使用更快的磁盘设备；调整计划任务，做好磁盘维护
- 网卡流量
    - 如何避免无法连接数据库的情况
        - 减少从服务器(slave)的数量
        - 进行分级缓存
        - 避免使用select *进行查询
        - 分离业务网络和服务器网络
- 大表
    - 大表的相对概念：记录行数巨大，单表超过千万行；表数据文件巨大，表数据文件超过10G
    - 大表对查询的影响
        - 慢查询：很难在一定时间内过滤出所需要的数据
    - 大表对DDL操作的影响：
        - 1.建立索引需要很长的时间
            - 风险：MySQL版本<5.5建立索引会锁表
            - MySQL版本≥5.5版本虽然不会锁表但会引起主从延迟
        - 2.修改表结构需要长时间锁表
            - 风险：会造成长时间的主从延迟；影响正常的数据操作
    - 如何处理数据库中的大表
        - 1.分库分表把一张大表分成多个小表
            - 难点：分表主键的选择；分表后跨分区数据的查询和统计
        - 2.大表的历史数据归档：减少对前后端业务的影响
            - 难点：归档时间点的选择；如何进行归档的操作
- 大事务
    - 大事务定义：运行时间比较长，操作的数据比较多的事务
        - 风险：锁定太多的数据，造成大量的阻塞和锁超时；回滚时所需的时间比较长；执行时间长，容易造成主从延迟
    - 如何处理大事务
        - 避免一次处理太多的数据
        - 移出不必要在事务中的SELECT操作



## 什么因素影响了MYSQL数据库性能
- 1.服务器硬性
    - 如何选择服务器与版本
        - 特殊情况
            - 64位的mysql版本使用32位的服务器版本
    - 如何选择内存
    - 如何选择磁盘
        - 1.存储容量 2.传输速度 3.访问时间 4.主轴转速  5.物理尺寸
- 2.服务器系统
- 3.数据库存储引擎的选择
    - MyISAM：不支持事务，表级锁
    - InnoDB：事务级存储引擎，完美支持行级锁，事务ACID特性
- 4.数据库参数配置（影响巨大）
- 5.数据库结构设计和SQL语句的编写
    - 数据库设计对性能的影响的不好举措
        - 1.过分的反范式话为表建立太多的列
        - 2.过分的范式化造成太多的表关联
        - 3.在OLTP环境中使用不恰当的分区表
        - 4.使用外键保证数据的完整性
- 总结：
    - 性能优化顺序
        - 1.数据库结构设计和SQL语句
        - 2.数据库存储引擎的选择和参数配置
        - 3.系统选择及优化
        - 4.硬件升级


## 优化系统配置

系统参数控制着资源的配置，调整系统参数的值，可以帮助我们提升资源的利用效率。

1. 调整系统参数InnoDB_flush_log_at_trx_commit  
这个参数存储在MySQL的配置文件my.ini里面，默认的值是1，意思是每次提交事务的时候，都把数据写入日志，并把日志写入磁盘。这样做的好处是数据安全性最佳，不足之处在于每次提交事务，都要进行磁盘写入的操作。在大并发的场景下，过于频繁的磁盘读写会导致CPU资源浪费，系统效率变低。  
这个参数的值还有2个可能的选项，分别是0和2。其中，0表示每隔1秒将数据写入日志，并将日志写入磁盘；2表示，每次提交事务的时候都将数据写入日志，但是日志每间隔1秒写入磁盘。  
最后，我们把这个参数的值改成了2。这样一来，就不用每次提交事务的时候都启动磁盘读写了，在大并发的场景下，可以改善系统效率，降低CPU使用率。即便出现故障，损失的数据也比较小。0虽然效率更高一些，但是数据安全性方面不如2。

2. 调整系统参数InnoDB_buffer_pool_size  
这个参数的意思是，InnoDB存储引擎使用缓存来存储索引和数据。这个值越大，可以加载到缓存区的索引和数据量就越多，需要的磁盘读写就越少。  
因为我们的MySQL服务器是数据库专属服务器，只用来运行MySQL数据库服务，没有其他应用了，而我们的计算机是64位机，内存也有128G。于是我们把这个参数的值调整为64G。这样一来，磁盘读写次数可以大幅降低，我们就可以充分利用内存，释放出一些CPU的资源。

3. 调整系统参数InnoDB_buffer_pool_instances  
这个参数的意思是，将InnoDB的缓存区分成几个部分，这样一来，就可以提高系统的并行处理能力，因为可以允许多个进程同时处理不同部分的缓存区。

把InnoDB_buffer_pool_instances的值修改为64，意思就是把InnoDB的缓存区分成64个分区，这样就可以同时有多个进程进行数据操作，CPU的效率就高多了。  

把InnoDB_buffer_pool_instances的值修改为64，意思就是把InnoDB的缓存区分成64
个分区，这样就可以同时有多个进程进行数据操作，CPU的效率就高多了。
### CPU资源不足的问题的解决方案
CPU资源是系统的核心资源，获取成本非常高。CPU的特点就是阻塞，只要CPU一开始计算，就意味着等待。遇到CPU资源不足的问题，可以从2个思路去解决：  
1. 疏通拥堵路段，消除瓶颈，让等待的时间更短；
2. 开拓新的通道，增加并行处理能力。

### 系统监控来诊断问题
MySQL提供了很好的工具：Performance Schema。
这是一种专门用来监控服务器执行情况的存储引擎，它会把监控服务器执行情况的数据记录在系统自带的数据库performance_schema中。我们可以利用监控的数据，对服务器中执行查询的问题进行诊断。
系统数据库performance_schema中的表setup_instruments和setup_consumers中的数
据，是启用监控的关键。  
- setup_instruments保存的数据，表示哪些对象发生的事件可以被系统捕获（在MySQL中，把这些事件称作信息生产者）。
- setup_consumers这个表保存的数据，则指定了是否保存监控事件发生的信息。在MySQL中，PerformanceSchema把监控到的事件信息存入performance_schema中的数据表中，这些数据表保存了事件的监控信息，扮演了事件监控信息消费者的角色，被称为消费者。

为了利用保存下来的监控事件信息来诊断系统问题，几个保存监控信息数据的系统数据表：
1. performance_schema.events_statements_current  
这个表中记录的是当前系统中的查询事件。表中的每一行对应一个进程，一个进程只有一行数据，显示的是每个进程中被监控到的查询事件。
2. performance_schema.events_statements_history  
这个表中记录了系统中所有进程中最近发生的查询事件。这个表中包含的查询事件都是已经完成了的。另外，表中可以为每个进程保存的最大记录数由系统变量决定。
3. performance_schema.events_statements_history_long  
这个表中记录了系统中所有进程中最近发生的查询事件，表中包含的查询事件都是已经完成了的。同时，这个表中可以保存的记录数由系统变量决定。


